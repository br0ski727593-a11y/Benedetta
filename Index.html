<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Board Tutor</title>
    <style>
        :root { 
            --primary: #2563eb; 
            --background: #f8fafc; 
            --surface: #ffffff;
            --text: #0f172a; 
            --ai-color: #7c3aed; 
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--background); 
            color: var(--text); 
            line-height: 1.6; 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
        }

        .app-container { 
            background: var(--surface); 
            width: 100%; 
            max-width: 800px; 
            padding: 2.5rem; 
            border-radius: 16px; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); 
        }

        .hidden { display: none; }
        
        button { cursor: pointer; border: none; font-weight: 700; transition: transform 0.1s, opacity 0.2s; }
        button:active { transform: scale(0.98); }

        /* Main Start Button */
        .primary-btn { 
            background: var(--primary); 
            color: white; 
            width: 100%; 
            font-size: 1.2rem; 
            padding: 16px; 
            border-radius: 12px; 
            margin-top: 20px; 
        }
        
        /* AI Button */
        .ai-btn { 
            background: linear-gradient(135deg, #7c3aed, #6d28d9); 
            color: white; 
            padding: 12px 24px; 
            border-radius: 8px; 
            margin: 25px auto; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            width: 100%; 
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(124, 58, 237, 0.2);
        }
        
        /* Quiz Options */
        .option-btn { 
            display: block; 
            width: 100%; 
            padding: 16px; 
            margin: 12px 0; 
            border: 2px solid #e2e8f0; 
            background: white; 
            text-align: left; 
            border-radius: 12px; 
            font-size: 1rem; 
            color: var(--text);
        }
        .option-btn:hover { border-color: var(--primary); background: #eff6ff; }
        
        .option-btn.correct { background: #dcfce7; border-color: #16a34a; color: #14532d; }
        .option-btn.wrong { background: #fee2e2; border-color: #dc2626; color: #7f1d1d; }
        .option-btn.selected { border-color: var(--primary); background: #eff6ff; font-weight: 600; }
        
        /* AI Box */
        #ai-response-box { 
            background: #f5f3ff; 
            padding: 20px; 
            border-radius: 12px; 
            margin-top: 15px; 
            display: none; 
            border: 1px solid #d8b4fe; 
            color: #4c1d95; 
            font-size: 0.95rem;
        }
        
        /* Navigation */
        .nav-container { display: flex; justify-content: space-between; margin-top: 30px; }
        .nav-btn { 
            background: white; 
            border: 2px solid #e2e8f0; 
            padding: 10px 24px; 
            border-radius: 8px; 
            color: #64748b; 
        }
        .nav-btn:hover { border-color: #94a3b8; color: var(--text); }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .header { display: flex; justify-content: space-between; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* Loading Animation */
        .dots::after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }

        /* focus visible for keyboard users */
        :focus { outline: 3px solid rgba(37,99,235,0.2); outline-offset: 2px; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="setup-view" style="text-align:center; padding: 2rem 0;">
        <h1 style="color: var(--primary); margin-bottom: 10px;">Medical Board Tutor</h1>
        <p style="color: #64748b;">AI Status: <strong style="color: #16a34a;">CONNECTED</strong></p>
        <p style="font-size: 0.9rem; color: #94a3b8;">Ready to start your session?</p>
        <button class="primary-btn" onclick="startNewQuiz()">Start Quiz</button>
    </div>

    <div id="quiz-view" class="hidden">
        <div class="header">
            <span id="progress-text" style="font-weight:700; color:#64748b; font-size: 0.9rem; text-transform: uppercase;">Question 1</span>
            <span id="score-text" style="font-weight:700; color:var(--primary); font-size: 0.9rem; text-transform: uppercase;">Score: 0%</span>
        </div>
        
        <p id="q-text" tabindex="0" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;"></p>
        <div id="options-container"></div>
        
        <button class="ai-btn" id="ai-btn" onclick="askAI()">
            <span>âœ¨ Explain This Question</span>
        </button>
        <div id="ai-response-box" aria-live="polite"></div>

        <div class="nav-container">
            <button class="nav-btn" id="prev-btn" onclick="nav(-1)">Previous</button>
            <button class="nav-btn" id="next-btn" onclick="nav(1)">Next</button>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
             <button onclick="exitToMenu()" style="background: none; text-decoration: underline; color: #94a3b8; font-weight: normal; font-size: 0.9rem;">Exit to Menu</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // CONFIGURATION
    // ==========================================
    // NOTE: API key must NOT be stored in client-side code.
    // The client calls a proxy endpoint on the same origin: "/api/generate"
    const API_PROXY_ENDPOINT = '/api/generate';
    // ==========================================

    // --- DATABASE (First 30 Questions) ---
    const db = [
        { q: "A 10-month-old boy is poorly gaining weight. His mother complains about his constant persistent cough. Sputum is thick and viscous. The boy had pneumonia three times. His sweat chloride [...]",
          o: ["Option A","Option B","Option C","Option D"], a: 2 },
        { q: "A 42-year-old man, suffering from duodenal ulcer for 20 years, reports heaviness in stomach, eructation with smell of decay, vomiting food eaten the day before, and 'sloshing sound' in e[...]",
          o: ["Option A","Option B","Option C","Option D"], a: 1 },
        // ... (rest of entries; ensure each entry that should have a correct answer has `a: <index>`)
    ];

    let activeQ = [];
    let answers = {};
    let idx = 0;

    // safer shuffle (Fisherâ€“Yates) which does not mutate original db
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function startNewQuiz() {
        activeQ = shuffleArray(db); 
        answers = {};               // reset answers correctly
        idx = 0;
        document.getElementById('setup-view').classList.add('hidden');
        document.getElementById('quiz-view').classList.remove('hidden');
        render();
    }
    
    function exitToMenu() {
        if(confirm("Exit to main menu? Progress will be lost.")) {
            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById('setup-view').classList.remove('hidden');
        }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function render() {
        const q = activeQ[idx];
        document.getElementById('progress-text').innerText = `Question ${idx + 1}/${activeQ.length}`;

        if (!q) {
          document.getElementById('q-text').innerText = 'Question data unavailable.';
          document.getElementById('options-container').innerHTML = '';
          return;
        }

        document.getElementById('q-text').innerText = q.q;
        
        let correctCount = 0;
        let answeredCount = 0;
        Object.keys(answers).forEach(k => {
            answeredCount++;
            if (typeof activeQ[k]?.a === 'number' && answers[k] === activeQ[k].a) correctCount++;
        });
        const score = answeredCount === 0 ? 0 : Math.round((correctCount/answeredCount)*100);
        document.getElementById('score-text').innerText = `Score: ${score}%`;

        const div = document.getElementById('options-container');
        div.innerHTML = '';
        
        // If the question lacks a valid 'a' index, warn and disable AI/options
        const hasValidAnswerIndex = (typeof q.a === 'number' && q.a >= 0 && q.a < (q.o?.length || 0));
        if (!hasValidAnswerIndex) {
          const warn = document.createElement('div');
          warn.style.color = '#b45309';
          warn.style.background = '#fffbeb';
          warn.style.padding = '12px';
          warn.style.borderRadius = '8px';
          warn.style.border = '1px solid #fbbf24';
          warn.innerText = 'âš ï¸ This question is missing a valid correct-answer index. Options and AI explanation are disabled for this item.';
          div.appendChild(warn);
          document.getElementById('ai-btn').disabled = true;
        } else {
          document.getElementById('ai-btn').disabled = false;
          q.o.forEach((opt, i) => {
              const btn = document.createElement('button');
              btn.className = 'option-btn';
              btn.innerText = opt;
              if(answers[idx] !== undefined) {
                  if(i === q.a) btn.classList.add('correct');
                  if(i === answers[idx] && i !== q.a) btn.classList.add('wrong');
                  if(i === answers[idx]) btn.classList.add('selected');
              }
              btn.onclick = () => { answers[idx] = i; render(); };
              div.appendChild(btn);
          });
        }
        
        document.getElementById('ai-response-box').style.display = 'none';
        
        document.getElementById('prev-btn').disabled = (idx === 0);
        document.getElementById('next-btn').disabled = (idx === activeQ.length - 1);

        // move focus to question text for screen-reader/keyboard users
        const qText = document.getElementById('q-text');
        if (qText) qText.focus();
    }

    function nav(d) {
        if(idx + d >= 0 && idx + d < activeQ.length) { idx += d; render(); }
    }

    async function askAI() {
        const q = activeQ[idx];
        const box = document.getElementById('ai-response-box');
        const aiBtn = document.getElementById('ai-btn');

        if (!q) return;
        if (typeof q.a !== 'number') {
          box.style.display = 'block';
          box.innerText = 'This question does not have a valid correct-answer index.';
          return;
        }

        aiBtn.disabled = true;
        box.style.display = 'block';
        box.innerHTML = "<span class='dots'><strong>ðŸ¤– AI is analyzing</strong></span>";

        const prompt = `
You are a medical board exam tutor.
Question: \"${q.q}\"
Correct Answer: \"${q.o[q.a]}\"
Options: ${JSON.stringify(q.o)}

Task:
1. Explain concisely why the correct answer is the best choice (focus on key clinical signs).
2. Briefly explain why the other options are incorrect/less likely.
3. Keep it educational and encouraging.
        `;

        try {
            const response = await fetch(API_PROXY_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });

            if (!response.ok) {
                const text = await response.text();
                box.innerHTML = `<span style=\"color:red\">AI Error: ${response.status} ${escapeHtml(text)}</span>`;
                return;
            }

            const data = await response.json();
            // server returns { output: '...' }
            const rawText = data.output || '';

            // Escape then convert newlines to <br> to avoid XSS
            const safe = escapeHtml(rawText).replace(/\n/g, '<br>');
            box.innerHTML = safe;
        } catch (e) {
            box.innerHTML = `<span style=\"color:red\">Connection Error: ${escapeHtml(e.message)}</span>`;
        } finally {
            aiBtn.disabled = false;
        }
    }
</script>
</body>
</html>